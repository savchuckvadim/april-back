name: Deploy NEST BACK API on push to main

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ CI –∑–∞–ø—É—â–µ–Ω
        run: echo "üöÄ NESTback api GitHub Actions –∑–∞–ø—É—â–µ–Ω"

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          timeout: 30m
          script: |
            echo "üß© –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É NEST API"
            cd /var/www/html/back.april-app
            git pull origin main
            tmux kill-session -t deploy-session-nest-api || true
            tmux new -d -s deploy-session-nest-api "docker-compose up -d --build && echo ‚úÖ nest-api –ì–æ—Ç–æ–≤–æ"

            echo "‚è≥ –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."
            for i in {1..90}; do
              if docker ps --filter "name=nest-api" --filter "status=running" | grep nest-api; then
                echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω!"
                break
              fi
              echo "‚åõ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
              sleep 5
            done

            sleep 5
            echo "‚è≥1 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."

            sleep 35
            echo "‚è≥1 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."


            sleep 55
            echo "‚è≥1 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."

            sleep 5
            echo "‚è≥2 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."

            sleep 35
            echo "‚è≥2 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."


            sleep 55
            echo "‚è≥2 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."
            
            docker ps -a


            sleep 35
            echo "‚è≥3 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."


            sleep 55
            echo "‚è≥3 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."


            sleep 35
            echo "‚è≥4 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."
            docker ps -a

            sleep 55
            echo "‚è≥4 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."
            

            sleep 35
            echo "‚è≥5 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."


            sleep 55
            echo "‚è≥5 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."

            docker ps -a
            sleep 35
            echo "‚è≥6 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."


            sleep 55
            echo "‚è≥6 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."

            docker ps -a
            sleep 35
            echo "‚è≥7 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."


            sleep 55
            echo "‚è≥7 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."
            docker ps -a
            docker logs nest-api || true
