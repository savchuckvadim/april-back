# name: Deploy NEST BACK API on push to main

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: ‚úÖ CI –∑–∞–ø—É—â–µ–Ω
#         run: echo "üöÄ NESTback api GitHub Actions –∑–∞–ø—É—â–µ–Ω"

#       - name: Deploy to server via SSH
#         uses: appleboy/ssh-action@v0.1.10
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_SSH_KEY }}
#           timeout: 30m
        
#           debug: true
#           script: |
#             echo "üß© –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É NEST API"
#             cd /var/www/html/back.april-app
#             git pull origin main
            
#             tmux kill-session -t deploy-session-nest-api || true
#             tmux new -d -s deploy-session-nest-api "docker-compose up -d --build && echo ‚úÖ nest-api –ì–æ—Ç–æ–≤–æ"

#             echo "‚è≥ –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."
#             old_id=$(docker ps --filter "name=nest-api" --format "{{.ID}}")

#             docker-compose up -d --build

#             echo "‚è≥ –ñ–¥—É, –ø–æ–∫–∞ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
#             for i in {1..60}; do
#               new_id=$(docker ps --filter "name=nest-api" --format "{{.ID}}")
#               if [ "$new_id" != "$old_id" ]; then
#                 echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–±–Ω–æ–≤–∏–ª—Å—è: $old_id ‚Üí $new_id"
#                 break
#               fi
#               echo "‚åõ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—â—ë —Å—Ç–∞—Ä—ã–π, –∂–¥—É..."
#               sleep 2
#             done


#             sleep 55
#             echo "‚è≥7 –ñ–¥—É, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nest-api –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è..."
#             docker ps -a
#             docker logs nest-api || true
